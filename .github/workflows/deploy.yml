name: Deploy Tennis Bot

on:
  push:
    branches: [ main, develop ] # Aseg칰rate de que tu rama se llama 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    
    # 1. Descargar el c칩digo
    - name: 游닌 Checkout code
      uses: actions/checkout@v4

    # 2. Copiar archivos al VPS (Usando la ruta espec칤fica)
    - name: 游뚴 Copy files via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        # NOTA: Agregamos '/expense-tracker-bot' para que tenga su propia carpeta ordenada
        target: "/root/apps/automations/expense-tracker-bot"

    # 3. Entrar y Ejecutar Docker
    - name: 游 Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Crear la carpeta si no existe
          mkdir -p /root/apps/automations/expense-tracker-bot
          
          # Entrar al directorio
          cd /root/apps/automations/expense-tracker-bot
          
          # Crear archivo .env desde secretos
          echo "${{ secrets.ENV_FILE_EXPENSE }}" > .env
          
          # Reiniciar el servicio
          echo "游댃 Desplegando nueva versi칩n..."
          docker compose down
          docker compose up -d --build
          
          # Limpiar im치genes viejas para ahorrar espacio
          docker image prune -f