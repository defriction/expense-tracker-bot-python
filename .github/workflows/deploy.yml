name: Deploy Tennis Bot

on:
  push:
    branches: [ main, master, develop ]

env:
  DEPLOY_ENV: ${{ github.ref_name == 'develop' && 'dev' || 'prod' }}
  APP_DIR: ${{ github.ref_name == 'develop' && '/root/apps/automations/expense-tracker-bot-dev' || '/root/apps/automations/expense-tracker-bot' }}
  TRAEFIK_PATH_PREFIX: ${{ github.ref_name == 'develop' && '/expense-dev/v1' || '/expense/v1' }}
  IMAGE_NAME: ${{ github.ref_name == 'develop' && 'expense-tracker-bot:dev' || 'expense-tracker-bot:latest' }}
  CONTAINER_NAME: ${{ github.ref_name == 'develop' && 'expense-tracker-bot-dev' || 'expense-tracker-bot' }}
  TRAEFIK_ROUTER_NAME: ${{ github.ref_name == 'develop' && 'expense-bot-dev' || 'expense-bot' }}
  TRAEFIK_MIDDLEWARE_NAME: ${{ github.ref_name == 'develop' && 'expense-strip-dev' || 'expense-strip' }}
  COMPOSE_PROJECT_NAME: ${{ github.ref_name == 'develop' && 'expense-bot-dev' || 'expense-bot' }}
  COMPOSE_FILE: ${{ github.ref_name == 'develop' && 'docker-compose.dev.yml' || 'docker-compose.yml' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸšš Copy files via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: "${{ env.APP_DIR }}"

    - name: ðŸš€ Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e

          mkdir -p ${{ env.APP_DIR }}
          cd ${{ env.APP_DIR }}

          if [ "${{ github.ref_name }}" = "develop" ]; then
            echo "${{ secrets.ENV_FILE_EXPENSE_DEV }}" > .env
          else
            echo "${{ secrets.ENV_FILE_EXPENSE }}" > .env
          fi
          echo "DEPLOY_ENV=${{ env.DEPLOY_ENV }}" >> .env
          echo "TRAEFIK_PATH_PREFIX=${{ env.TRAEFIK_PATH_PREFIX }}" >> .env
          echo "IMAGE_NAME=${{ env.IMAGE_NAME }}" >> .env
          echo "CONTAINER_NAME=${{ env.CONTAINER_NAME }}" >> .env
          echo "TRAEFIK_ROUTER_NAME=${{ env.TRAEFIK_ROUTER_NAME }}" >> .env
          echo "TRAEFIK_MIDDLEWARE_NAME=${{ env.TRAEFIK_MIDDLEWARE_NAME }}" >> .env
          echo "COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}" >> .env
          echo "COMPOSE_FILE=${{ env.COMPOSE_FILE }}" >> .env

          echo "ðŸ”„ Desplegando nueva versiÃ³n..."
          COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }} docker compose -f ${{ env.COMPOSE_FILE }} down
          COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }} docker compose -f ${{ env.COMPOSE_FILE }} up -d --build

          docker image prune -f
