name: Deploy Tennis Bot

on:
  push:
    branches: [ main, master, develop ]

env:
  DEPLOY_ENV: ${{ github.ref_name == 'develop' && 'dev' || 'prod' }}
  APP_DIR: ${{ github.ref_name == 'develop' && '/root/apps/automations/expense-tracker-bot-dev' || '/root/apps/automations/expense-tracker-bot' }}
  TRAEFIK_PATH_PREFIX: ${{ github.ref_name == 'develop' && '/expense-dev/v1' || '/expense/v1' }}
  IMAGE_NAME: ${{ github.ref_name == 'develop' && 'expense-tracker-bot:dev' || 'expense-tracker-bot:latest' }}
  CONTAINER_NAME: ${{ github.ref_name == 'develop' && 'expense-tracker-bot-dev' || 'expense-tracker-bot' }}
  TRAEFIK_ROUTER_NAME: ${{ github.ref_name == 'develop' && 'expense-bot-dev' || 'expense-bot' }}
  TRAEFIK_MIDDLEWARE_NAME: ${{ github.ref_name == 'develop' && 'expense-strip-dev' || 'expense-strip' }}
  COMPOSE_PROJECT_NAME: ${{ github.ref_name == 'develop' && 'expense-bot-dev' || 'expense-bot' }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    
    # 1. Descargar el c칩digo
    - name: 游닌 Checkout code
      uses: actions/checkout@v4

    # 2. Copiar archivos al VPS (Usando la ruta espec칤fica)
    - name: 游뚴 Copy files via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        # NOTA: Agregamos '/expense-tracker-bot' para que tenga su propia carpeta ordenada
        target: "${{ env.APP_DIR }}"

    # 3. Entrar y Ejecutar Docker
    - name: 游 Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Crear la carpeta si no existe
          mkdir -p ${{ env.APP_DIR }}
          
          # Entrar al directorio
          cd ${{ env.APP_DIR }}
          
          # Crear archivo .env desde secretos
          echo "${{ secrets.ENV_FILE_EXPENSE }}" > .env
          echo "DEPLOY_ENV=${{ env.DEPLOY_ENV }}" >> .env
          echo "TRAEFIK_PATH_PREFIX=${{ env.TRAEFIK_PATH_PREFIX }}" >> .env
          echo "IMAGE_NAME=${{ env.IMAGE_NAME }}" >> .env
          echo "CONTAINER_NAME=${{ env.CONTAINER_NAME }}" >> .env
          echo "TRAEFIK_ROUTER_NAME=${{ env.TRAEFIK_ROUTER_NAME }}" >> .env
          echo "TRAEFIK_MIDDLEWARE_NAME=${{ env.TRAEFIK_MIDDLEWARE_NAME }}" >> .env
          echo "COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }}" >> .env
          
          # Reiniciar el servicio
          echo "游댃 Desplegando nueva versi칩n..."
          COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }} docker compose down
          COMPOSE_PROJECT_NAME=${{ env.COMPOSE_PROJECT_NAME }} docker compose up -d --build
          
          # Limpiar im치genes viejas para ahorrar espacio
          docker image prune -f
